<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch File Renamer Tool - Engineering Edition</title>
    
    <!-- 1. 引入 Tailwind CSS (負責樣式) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 引入 React 核心 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. 引入 Babel (讓瀏覽器能看懂 JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. 引入 JSZip (負責壓縮) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        /* 自定義捲軸樣式，讓介面更像工程軟體 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        .drag-active {
            border-color: #2563eb !important;
            background-color: #eff6ff !important;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
    
    <!-- React 應用掛載點 -->
    <div id="root"></div>

    <!-- React 應用程式邏輯 -->
    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // --- 內嵌圖示組件 (移除外部依賴，確保穩定性) ---
        const Icons = {
            RefreshCw: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,
            Upload: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Download: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Trash2: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            Settings: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            ArrowRight: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>,
            FileDigit: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M4 22h14a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v4"/><polyline points="14 2 14 8 20 8"/><path d="M2 15h4"/><path d="M2 15v3c0 1.1.9 2 2 2h0c1.1 0 2-.9 2-2v-3"/></svg>,
            FileType: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>,
            AlertCircle: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        };

        // --- 主程式邏輯 ---
        function App() {
            const [files, setFiles] = useState([]);
            const [startNum, setStartNum] = useState(1);
            const [minDigits, setMinDigits] = useState(2);
            const [prefix, setPrefix] = useState('');
            const [isZipping, setIsZipping] = useState(false);
            const [isDragging, setIsDragging] = useState(false);

            // 處理檔案上傳與智慧排序
            const handleFileUpload = (e) => {
                let fileList = [];
                
                // FIX: 優先檢查 e.dataTransfer (拖放來源)，其次才是 e.target.files (點擊上傳來源)
                // 原先寫法會被 input 的空 e.target.files 截斷，導致拖放無效
                if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    fileList = e.dataTransfer.files;
                } else if (e.target && e.target.files && e.target.files.length > 0) {
                    fileList = e.target.files;
                }

                const selectedFiles = Array.from(fileList);
                if (selectedFiles.length === 0) return; // 沒有檔案則退出

                // Natural Sort Algorithm (自然排序法)
                // 讓 "1.jpg, 2.jpg, 10.jpg" 排序正確，而不是 "1, 10, 2"
                const collator = new Intl.Collator(undefined, { numeric: true, sensitivity: 'base' });
                
                setFiles(prev => {
                    // 合併並簡單過濾重複 (依據檔名+大小)
                    const combined = [...prev, ...selectedFiles];
                    const unique = combined.filter((v, i, a) => 
                        a.findIndex(t => (t.name === v.name && t.size === v.size)) === i
                    );
                    return unique.sort((a, b) => collator.compare(a.name, b.name));
                });
            };

            const clearFiles = () => setFiles([]);
            const removeFile = (index) => setFiles(prev => prev.filter((_, i) => i !== index));

            const getNewName = (originalName, index) => {
                const extension = originalName.slice((Math.max(0, originalName.lastIndexOf(".")) || Infinity));
                const num = startNum + index;
                const numStr = num.toString().padStart(minDigits, '0');
                return `${prefix}${numStr}${extension}`;
            };

            // 拖曳處理事件
            const onDragEnter = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragging(true);
            };

            const onDragOver = (e) => {
                e.preventDefault();
                e.stopPropagation();
                // 必須在這裡也設為 true，防止閃爍
                if (!isDragging) setIsDragging(true);
            };

            const onDragLeave = (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                // 只有當離開的目標是真正離開區域時才取消高亮
                // (解決子元素導致的閃爍問題，這裡簡單處理直接取消，因為有 overlay)
                if (e.currentTarget.contains(e.relatedTarget)) return;
                
                setIsDragging(false);
            };

            const onDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragging(false);
                handleFileUpload(e);
            };

            // 打包下載邏輯
            const handleDownload = async () => {
                if (!window.JSZip) {
                    alert("JSZip 核心組件載入失敗，請檢查網路連線。");
                    return;
                }
                if (files.length === 0) return;

                setIsZipping(true);
                const zip = new window.JSZip();

                files.forEach((file, index) => {
                    const newName = getNewName(file.name, index);
                    zip.file(newName, file);
                });

                try {
                    const content = await zip.generateAsync({ type: "blob" });
                    const url = window.URL.createObjectURL(content);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `renamed_files_${new Date().toISOString().slice(0,10)}.zip`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                } catch (error) {
                    console.error("Zipping error:", error);
                    alert("打包過程發生錯誤。");
                } finally {
                    setIsZipping(false);
                }
            };

            return (
                <div className="min-h-screen p-4 md:p-8">
                    <div className="max-w-5xl mx-auto space-y-6">
                        
                        {/* 標題區 */}
                        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 border-b border-slate-200 pb-4">
                            <div>
                                <h1 className="text-3xl font-bold text-slate-800 flex items-center gap-2">
                                    <Icons.RefreshCw className="w-8 h-8 text-blue-600" />
                                    Batch File Renamer
                                </h1>
                                <p className="text-slate-500 mt-1 font-mono text-sm">
                                    v1.2.0 | Engineering Tool | Local Processing
                                </p>
                            </div>
                            <div className="text-right hidden md:block">
                                <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    System Ready
                                </span>
                            </div>
                        </div>

                        {/* 主操作區 */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            
                            {/* 左側：控制面板 */}
                            <div className="lg:col-span-1 space-y-6">
                                
                                {/* 上傳區塊 (支援拖曳) */}
                                <div 
                                    className={`bg-white p-8 rounded-xl shadow-sm border-2 border-dashed transition-all duration-200 relative group cursor-pointer overflow-hidden
                                        ${isDragging ? 'drag-active scale-[1.02]' : 'border-slate-300 hover:border-blue-500 hover:bg-slate-50'}`}
                                    onDragEnter={onDragEnter}
                                    onDragOver={onDragOver}
                                    onDragLeave={onDragLeave}
                                    onDrop={onDrop}
                                >
                                    <input 
                                        type="file" 
                                        multiple 
                                        onChange={handleFileUpload} 
                                        className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                                        title="" 
                                    />
                                    <div className="text-center space-y-3 pointer-events-none relative z-0">
                                        <div className={`w-14 h-14 rounded-full flex items-center justify-center mx-auto transition-all duration-300
                                            ${isDragging ? 'bg-blue-100 text-blue-600 scale-110' : 'bg-blue-50 text-blue-600 group-hover:scale-110'}`}>
                                            <Icons.Upload className="w-6 h-6" />
                                        </div>
                                        <div>
                                            <p className={`font-semibold transition-colors ${isDragging ? 'text-blue-700' : 'text-slate-700'}`}>
                                                {isDragging ? 'Drop files here!' : '點擊或拖放檔案'}
                                            </p>
                                            <p className="text-xs text-slate-400 mt-1">支援圖片、Log、PDF 等任意格式</p>
                                        </div>
                                    </div>
                                    
                                    {/* 拖曳時的覆蓋層 (Visual Feedback) */}
                                    {isDragging && (
                                        <div className="absolute inset-0 bg-blue-50/50 pointer-events-none z-0 flex items-center justify-center">
                                            <div className="absolute inset-0 border-4 border-blue-400 rounded-xl animate-pulse"></div>
                                        </div>
                                    )}
                                </div>

                                {/* 設定面板 */}
                                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 space-y-5">
                                    <div className="flex items-center gap-2 text-slate-800 font-bold text-sm uppercase tracking-wider border-b pb-2">
                                        <Icons.Settings className="w-4 h-4" />
                                        <span>Configuration</span>
                                    </div>
                                    
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-slate-600 mb-1.5">起始編號 (Start Index)</label>
                                            <input 
                                                type="number" 
                                                value={startNum}
                                                onChange={(e) => setStartNum(parseInt(e.target.value) || 0)}
                                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-mono text-lg"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-slate-600 mb-1.5">補零位數 (Padding)</label>
                                            <div className="grid grid-cols-4 gap-2">
                                                {[1, 2, 3, 4].map(digit => (
                                                    <button
                                                        key={digit}
                                                        onClick={() => setMinDigits(digit)}
                                                        className={`py-1.5 text-sm font-medium border rounded transition-all ${
                                                            minDigits === digit 
                                                            ? 'bg-blue-600 text-white border-blue-600 shadow-sm' 
                                                            : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'
                                                        }`}
                                                    >
                                                        {digit}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-slate-600 mb-1.5">前綴字串 (Prefix)</label>
                                            <input 
                                                type="text" 
                                                value={prefix}
                                                onChange={(e) => setPrefix(e.target.value)}
                                                placeholder="e.g. ESP32_"
                                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-mono text-sm"
                                            />
                                        </div>
                                        
                                        {/* 預覽區塊 */}
                                        <div className="bg-slate-100 p-3 rounded-lg text-center">
                                            <span className="text-xs text-slate-500 uppercase font-bold">Preview Output</span>
                                            <div className="font-mono text-blue-700 font-medium mt-1 text-lg">
                                                {prefix}{String(startNum).padStart(minDigits, '0')}.ext
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* 動作按鈕 */}
                                {files.length > 0 && (
                                    <div className="space-y-3 pt-2">
                                        <button 
                                            onClick={handleDownload}
                                            disabled={isZipping}
                                            className={`w-full flex items-center justify-center gap-2 py-3.5 rounded-lg text-white font-bold shadow-lg shadow-blue-200 active:scale-[0.98] transition-all ${
                                                isZipping ? 'bg-slate-400 cursor-wait' : 'bg-blue-600 hover:bg-blue-700'
                                            }`}
                                        >
                                            {isZipping ? (
                                                'Processing...'
                                            ) : (
                                                <>
                                                    <Icons.Download className="w-5 h-5" />
                                                    Download ZIP
                                                </>
                                            )}
                                        </button>
                                        <button 
                                            onClick={clearFiles}
                                            className="w-full py-2 text-slate-400 hover:text-red-500 text-sm flex items-center justify-center gap-1 transition-colors font-medium"
                                        >
                                            <Icons.Trash2 className="w-4 h-4" /> Reset List
                                        </button>
                                    </div>
                                )}
                            </div>

                            {/* 右側：預覽表格 */}
                            <div className="lg:col-span-2 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col overflow-hidden h-[700px]">
                                <div className="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center backdrop-blur-sm">
                                    <h2 className="font-bold text-slate-700 flex items-center gap-2">
                                        <Icons.FileDigit className="w-5 h-5 text-slate-500" />
                                        Files Queue
                                    </h2>
                                    <span className="text-xs font-mono bg-slate-200 px-2 py-1 rounded text-slate-600">
                                        Total: {files.length}
                                    </span>
                                </div>
                                
                                <div className="flex-1 overflow-y-auto overflow-x-hidden relative">
                                    {files.length === 0 ? (
                                        <div className="absolute inset-0 flex flex-col items-center justify-center text-slate-300">
                                            <Icons.FileType className="w-16 h-16 mb-4 opacity-50" />
                                            <p className="text-lg font-medium">Waiting for input...</p>
                                        </div>
                                    ) : (
                                        <table className="w-full text-left text-sm border-collapse">
                                            <thead className="bg-slate-50 sticky top-0 z-10 shadow-sm text-xs uppercase text-slate-500 font-semibold tracking-wider">
                                                <tr>
                                                    <th className="p-4 w-16 text-center">#</th>
                                                    <th className="p-4">Original Filename</th>
                                                    <th className="p-4 w-10"></th>
                                                    <th className="p-4 text-blue-600">New Filename</th>
                                                    <th className="p-4 w-16 text-right">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {files.map((file, idx) => {
                                                    const newName = getNewName(file.name, idx);
                                                    return (
                                                        <tr key={`${file.name}-${idx}`} className="hover:bg-blue-50/50 group transition-colors">
                                                            <td className="p-4 text-center text-slate-400 font-mono text-xs">{idx + 1}</td>
                                                            <td className="p-4 text-slate-600 truncate max-w-[180px]" title={file.name}>
                                                                {file.name}
                                                            </td>
                                                            <td className="p-4 text-slate-300">
                                                                <Icons.ArrowRight className="w-4 h-4" />
                                                            </td>
                                                            <td className="p-4 text-blue-700 font-bold font-mono truncate max-w-[180px]">
                                                                {newName}
                                                            </td>
                                                            <td className="p-4 text-right">
                                                                <button 
                                                                    onClick={() => removeFile(idx)}
                                                                    className="text-slate-300 hover:text-red-500 p-1.5 rounded hover:bg-red-50 transition-all opacity-0 group-hover:opacity-100"
                                                                    title="Remove file"
                                                                >
                                                                    <Icons.Trash2 className="w-4 h-4" />
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Render App
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
